image: node:18.12

stages:
  - build
  - deploy

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - cd Modules
    - npm ci
    - npm run build
    - echo "Compile complete."
  only:
    - master
  artifacts:
    paths:
      - Modules/build/*

deploy-job:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  environment: production
  script:
    - echo "Deploying application..."
    - cd Modules
    - aws s3 rm s3://${S3_BUCKET} --recursive
    - echo S3 bucket is cleared.

    # Copy dist folder to S3 bucket:
    - aws s3 cp build s3://${S3_BUCKET} --recursive

    # Create CloudFront invalidation (which actually clears cache):
    - aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths ${INVALIDATION_PATH:-"/*"} --output text --query "Invalidation.Id" > invalidation-id.txt
    - aws cloudfront wait invalidation-completed --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --id $(cat invalidation-id.txt)
    - echo "Application successfully deployed."
  only:
    - master
